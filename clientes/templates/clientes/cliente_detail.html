{% extends 'core/base.html' %}

{% block extra_head %}
<!-- Adiciona o CSS do Leaflet no <head> da página -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
{% endblock %}

{% block title %}Detalhes do Cliente{% endblock %}
{% block page_title %}Detalhes de {{ cliente.nome_razao_social }}{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Dados do Cliente</h5>
        <div>
            <a href="{% url 'clientes:cliente_update' cliente.pk %}" class="btn btn-primary btn-sm"><i class="bi bi-pencil-square"></i> Editar Cliente</a>
            <a href="{% url 'clientes:cliente_list' %}" class="btn btn-secondary btn-sm"><i class="bi bi-arrow-left"></i> Voltar para a Lista</a>
        </div>
    </div>
    <div class="card-body p-4">
        <div class="row g-3">
            <!-- SEÇÃO DE IDENTIFICAÇÃO -->
            <h6 class="border-bottom pb-2">Identificação</h6>
            <div class="col-md-6"><p><strong>Tipo de Pessoa:</strong> {{ cliente.get_tipo_pessoa_display }}</p></div>
            <div class="col-md-6"><p><strong>Nome / Razão Social:</strong> {{ cliente.nome_razao_social }}</p></div>
            <div class="col-md-6"><p><strong>Email:</strong> {{ cliente.email|default:"-" }}</p></div>
            <div class="col-md-6"><p><strong>Telefone:</strong> {{ cliente.telefone|default:"-" }}</p></div>

            <!-- SEÇÃO PF/PJ CONDICIONAL -->
            {% if cliente.tipo_pessoa == 'PF' %}
                <h6 class="mt-3 border-bottom pb-2">Dados de Pessoa Física</h6>
                <div class="col-md-6"><p><strong>CPF:</strong> {{ cliente.cpf|default:"-" }}</p></div>
                <div class="col-md-6"><p><strong>RG:</strong> {{ cliente.rg|default:"-" }}</p></div>
                <div class="col-md-4"><p><strong>Nacionalidade:</strong> {{ cliente.nacionalidade|default:"-" }}</p></div>
                <div class="col-md-4"><p><strong>Estado Civil:</strong> {{ cliente.estado_civil|default:"-" }}</p></div>
                <div class="col-md-4"><p><strong>Profissão:</strong> {{ cliente.profissao|default:"-" }}</p></div>
            {% else %}
                <h6 class="mt-3 border-bottom pb-2">Dados de Pessoa Jurídica</h6>
                <div class="col-md-6"><p><strong>CNPJ:</strong> {{ cliente.cnpj|default:"-" }}</p></div>
                <div class="col-md-6"><p><strong>Inscrição Estadual:</strong> {{ cliente.inscricao_estadual|default:"-" }}</p></div>
            {% endif %}

            <!-- SEÇÃO DE ENDEREÇO -->
            <h6 class="mt-3 border-bottom pb-2">Endereço</h6>
            <div class="col-md-3"><p><strong>CEP:</strong> {{ cliente.cep|default:"-" }}</p></div>
            <div class="col-md-7"><p><strong>Logradouro:</strong> {{ cliente.logradouro|default:"-" }}</p></div>
            <div class="col-md-2"><p><strong>Número:</strong> {{ cliente.numero|default:"-" }}</p></div>
            <div class="col-md-4"><p><strong>Complemento:</strong> {{ cliente.complemento|default:"-" }}</p></div>
            <div class="col-md-4"><p><strong>Bairro:</strong> {{ cliente.bairro|default:"-" }}</p></div>
            <div class="col-md-3"><p><strong>Cidade:</strong> {{ cliente.cidade|default:"-" }}</p></div>
            <div class="col-md-1"><p><strong>UF:</strong> {{ cliente.uf|default:"-" }}</p></div>

            <!-- MAPA ESTÁTICO (só aparece se houver coordenadas) -->
            {% if cliente.latitude and cliente.longitude %}
            <div class="col-12">
                <div class="card mt-3">
                    <div class="card-header">Localização</div>
                    <div class="card-body p-0">
                        <div id="mapDetail" style="height: 350px; width: 100%;"></div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<!-- Adiciona o JavaScript do Leaflet no final do <body> -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

{% if cliente.latitude and cliente.longitude %}
<script>
    // Usamos uma função anônima para evitar conflitos de variáveis globais
    (function() {
        // Verifica se a biblioteca 'L' (Leaflet) foi carregada
        if (typeof L === 'undefined') {
            console.error('Leaflet.js não foi carregado.');
            return;
        }

        // Pega as coordenadas do Django e formata para o JS
        const lat = {{ cliente.latitude|stringformat:"f" }};
        const lon = {{ cliente.longitude|stringformat:"f" }};
        
        const mapElement = document.getElementById('mapDetail');
        if (!mapElement) {
            console.error('Elemento do mapa #mapDetail não encontrado.');
            return;
        }

        // Cria o mapa e centraliza nas coordenadas salvas
        const map = L.map('mapDetail', {
            center: [lat, lon],
            zoom: 16,
            scrollWheelZoom: false // Desativa o zoom com a roda do mouse para melhor usabilidade
        });

        // Adiciona a camada de tiles do OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        // Adiciona o marcador (não arrastável) e um popup
        L.marker([lat, lon]).addTo(map)
            .bindPopup('{{ cliente.nome_razao_social|escapejs }}')
            .openPopup();
    })();
</script>
{% endif %}
{% endblock %}